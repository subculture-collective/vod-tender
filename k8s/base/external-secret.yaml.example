---
# External Secrets Operator integration for Kubernetes manifests
# This is an OPTIONAL alternative to the Secret manifest in secret.yaml
#
# Prerequisites:
# 1. External Secrets Operator installed: https://external-secrets.io/latest/introduction/getting-started/
# 2. SecretStore or ClusterSecretStore configured for your secret backend
#
# To use:
# 1. Configure your secret store (AWS Secrets Manager, Vault, GCP Secret Manager, etc.)
# 2. Update the secretStoreRef.name to match your SecretStore
# 3. Customize the data mappings for your secret structure
# 4. Comment out or remove secret.yaml from kustomization.yaml
# 5. Uncomment this file in kustomization.yaml

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vod-tender-secrets
  namespace: vod-tender
  labels:
    app: vod-tender
spec:
  refreshInterval: 1h
  
  # Reference to your SecretStore or ClusterSecretStore
  secretStoreRef:
    name: aws-secrets-manager  # Change to your secret store name
    kind: ClusterSecretStore   # Or SecretStore for namespace-scoped
  
  # Target secret to create/update
  target:
    name: vod-tender-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Database connection string
        db-dsn: "postgres://{{ .postgres_user }}:{{ .postgres_password }}@postgres:5432/vod?sslmode=require"
  
  # Data mappings - customize based on your secret structure
  data:
  # Twitch credentials
  - secretKey: twitch-client-id
    remoteRef:
      key: vod-tender/twitch
      property: client_id
  
  - secretKey: twitch-client-secret
    remoteRef:
      key: vod-tender/twitch
      property: client_secret
  
  - secretKey: twitch-oauth-token
    remoteRef:
      key: vod-tender/twitch
      property: oauth_token
  
  - secretKey: twitch-redirect-uri
    remoteRef:
      key: vod-tender/twitch
      property: redirect_uri
  
  - secretKey: twitch-scopes
    remoteRef:
      key: vod-tender/twitch
      property: scopes
  
  # YouTube credentials
  - secretKey: yt-client-id
    remoteRef:
      key: vod-tender/youtube
      property: client_id
  
  - secretKey: yt-client-secret
    remoteRef:
      key: vod-tender/youtube
      property: client_secret
  
  - secretKey: yt-redirect-uri
    remoteRef:
      key: vod-tender/youtube
      property: redirect_uri
  
  - secretKey: yt-scopes
    remoteRef:
      key: vod-tender/youtube
      property: scopes
  
  # Postgres credentials (for db-dsn template)
  - secretKey: postgres-password
    remoteRef:
      key: vod-tender/postgres
      property: password
  
  - secretKey: postgres_user
    remoteRef:
      key: vod-tender/postgres
      property: username
  
  - secretKey: postgres_password
    remoteRef:
      key: vod-tender/postgres
      property: password
  
  # Optional: AWS credentials for backup CronJob S3 uploads
  # - secretKey: aws-access-key-id
  #   remoteRef:
  #     key: vod-tender/aws
  #     property: access_key_id
  #
  # - secretKey: aws-secret-access-key
  #   remoteRef:
  #     key: vod-tender/aws
  #     property: secret_access_key

---
# Example ClusterSecretStore for AWS Secrets Manager
# Uncomment and configure for your environment

# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: aws-secrets-manager
# spec:
#   provider:
#     aws:
#       service: SecretsManager
#       region: us-east-1
#       auth:
#         jwt:
#           serviceAccountRef:
#             name: external-secrets-sa
#             namespace: external-secrets

---
# Example ClusterSecretStore for HashiCorp Vault
# Uncomment and configure for your environment

# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: vault-backend
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "external-secrets-role"
#           serviceAccountRef:
#             name: external-secrets-sa
#             namespace: external-secrets
